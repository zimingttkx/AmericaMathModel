# MCM Problem C 建模雷区与注意点详细指南

> **重要性**: 本文档记录了"与明星共舞"建模中的所有关键约束、雷区和注意点。代码必须严格遵守这些规则，否则会导致模型结果错误。

---

## 一、规则变迁时间线（核心约束条件）

### 1.1 阶段一：排名制 (Rank System)

| 属性 | 说明 |
|------|------|
| **适用赛季** | Season 1, Season 2 |
| **计算逻辑** | `TotalRank = Rank(JudgeScore) + Rank(FanVotes)` |
| **淘汰规则** | **TotalRank 数值最大者被淘汰** |
| **排名含义** | 第1名数值为1，第4名数值为4，数值越大排名越靠后 |

**验证示例（题目附录Table 2）**:
- Rachel: 总和 = 6 → 被淘汰
- Kelly: 总和 = 4 → 幸存
- 结论: 总和最大者淘汰 ✓

**平局处理（题目未明确，需假设）**:
```
假设优先级:
1. 粉丝投票排名较低者淘汰
2. 若仍平局，评委分较低者淘汰
3. 若仍平局，随机淘汰（需在论文中说明）
```

### 1.2 阶段二：百分比制 (Percentage System)

| 属性 | 说明 |
|------|------|
| **适用赛季** | Season 3 至 Season 27 |
| **计算逻辑** | `TotalScore = %JudgeScore + %FanVotes` |
| **淘汰规则** | **TotalScore 数值最小者被淘汰** |

**百分比计算公式**:
```
%JudgeScore = 某选手评委分 / 当周所有选手评委总分 × 100
%FanVotes = 某选手粉丝票数 / 当周总粉丝票数 × 100
```

**关键注意**:
- 分母只包含**当周还在比赛的人**（分数 > 0）
- 百分比之和应为 100%（或接近100%，考虑四舍五入）

### 1.3 阶段三：混合制 + 评委拯救 (Rank System + Judges' Save)

| 属性 | 说明 |
|------|------|
| **适用赛季** | Season 28 至 Season 34 |
| **计算逻辑** | 回归排名制 `TotalRank = Rank(JudgeScore) + Rank(FanVotes)` |
| **淘汰规则** | **综合排名倒数两名进入"生死PK"，由评委现场投票决定淘汰谁** |

**⚠️ 关键差异（暗坑！）**:
```
1. 综合排名倒数两名 (Bottom Two) 进入生死PK
2. 最终淘汰谁由评委现场投票决定，而非综合排名
3. 被淘汰者必须是 Bottom Two 之一
4. 综合排名倒数第二但未被淘汰是合理的（评委救了他）
```

**建模影响**:
```python
# S28-S34 的约束条件
if season >= 28:
    # 被淘汰者必须在 Bottom Two 中
    # 但不一定是综合排名最后一名
    constraint: eliminated_person in bottom_two
    # 而非: eliminated_person == last_rank
```

---

## 二、数据清洗与处理的"雷区"

### 2.1 0分含义

| 情况 | 含义 | 处理方式 |
|------|------|----------|
| 分数 = 0 | 该选手已被淘汰 | **必须从当周计算中排除** |
| 分数 > 0 | 选手仍在比赛 | 纳入计算 |

**错误示例**:
```python
# ❌ 错误：包含了已淘汰选手
total_judge_score = df['JudgeScore'].sum()

# ✓ 正确：只计算在场选手
total_judge_score = df[df['JudgeScore'] > 0]['JudgeScore'].sum()
```

### 2.2 评委人数变化

| 情况 | 评委人数 | 满分 |
|------|----------|------|
| 3个评委 | 3 | 30分 |
| 4个评委 | 4 | 40分 |

**⚠️ 不能直接用总分比较！**

**处理方案**:
```python
# 方案1：转化为占满分的百分比
normalized_score = judge_score / max_possible_score * 100

# 方案2：转化为平均分
avg_score = judge_score / num_judges

# 方案3：在百分比制下，直接用当周占比（自动归一化）
pct_score = judge_score / week_total_score * 100
```

### 2.3 小数与Bonus分数

| 情况 | 说明 |
|------|------|
| 小数分数 | 数据中存在 8.5 这种分数，模型**不能假设分数必须是整数** |
| Bonus分数 | 已直接加在总分里，**不需要额外处理Bonus逻辑** |

### 2.4 N/A值处理

| N/A含义 | 处理方式 |
|---------|----------|
| 缺席评委 | 剔除该评委分数，调整满分计算 |
| 休赛周 | 整周数据剔除 |
| 数据缺失 | 标记并在论文中说明 |

```python
# 读取数据时处理N/A
df = pd.read_csv('data.csv', na_values=['N/A', 'NA', '', ' '])
df = df.dropna(subset=['JudgeScore'])  # 或使用插值
```

### 2.5 多人淘汰/无人淘汰

| 情况 | 约束方程数量 | 处理方式 |
|------|--------------|----------|
| 淘汰1人 | 标准 | 1人得分 < 所有幸存者 |
| 淘汰2人 | 增加 | 2人得分 < 所有幸存者 |
| 无人淘汰 | 减少 | 该周无淘汰约束 |

```python
# 动态构建约束
for eliminated in eliminated_list:
    for survivor in survivor_list:
        # 每个被淘汰者 vs 每个幸存者
        add_constraint(score[eliminated] < score[survivor])
```

---

## 三、问题1建模注意点

### 3.1 未知量定义

| 变量 | 说明 | 范围 |
|------|------|------|
| 粉丝得票份额 | `v_i ∈ [0, 1]` | 所有选手份额之和 = 1 |
| 总票数 | 百分比制下不影响比例 | 可忽略 |

**简化处理**:
```
估算粉丝得票份额 (Share of Vote)
v_i ∈ [0, 1], Σv_i = 1
```

### 3.2 约束条件构造

**S3-S27（百分比制）**:
```
若 A 被淘汰，B 晋级:
Score_total(A) < Score_total(B)
即: %Judge(A) + %Fan(A) < %Judge(B) + %Fan(B)
```

**S1-S2（排名制）**:
```
若 A 被淘汰，B 晋级:
Rank_total(A) > Rank_total(B)
注意: 排名数值越大越差！
```

**S28-S34（混合制）**:
```
若 A 被淘汰:
A 必须在 Bottom Two 中
即: Rank_total(A) >= n-1 (n为当周选手数)
```

### 3.3 确定性(Certainty)衡量

| 情况 | 确定性 | 原因 |
|------|--------|------|
| 评委分差很大 | **低** | 粉丝投多少票都不会改变结果 |
| 评委分很接近 | **高** | 粉丝投票微小变化导致排名逆转 |

**衡量指标**:
```python
# 方法1: 可行解空间的体积
certainty = 1 / volume_of_feasible_region

# 方法2: 蒙特卡洛样本的方差
certainty = 1 / variance_of_samples

# 方法3: 约束紧度
certainty = min_margin / max_possible_margin
```

---

## 四、问题2建模注意点

### 4.1 控制变量法

**核心思路**: 用Q1算出的粉丝投票，套用不同的规则

```python
# 反事实分析
for season in seasons:
    original_method = get_original_method(season)
    counterfactual_method = get_opposite_method(original_method)
    
    # 用相同的粉丝投票数据
    fan_votes = estimated_fan_votes[season]
    
    # 应用不同规则
    original_result = apply_method(original_method, fan_votes)
    counterfactual_result = apply_method(counterfactual_method, fan_votes)
    
    # 比较结果差异
    compare(original_result, counterfactual_result)
```

### 4.2 具体案例分析

**Bobby Bones (S27)**:
```
背景: 在百分比制下获胜
分析问题: 如果S27使用S28的"评委拯救规则"，他会不会被淘汰？
预期: 他评分低，大概率会被评委投死
```

**Jerry Rice (S2)**:
```
背景: 在排名制下是亚军
分析问题: 如果换成百分比制，他的极低分数会不会被粉丝投票拉回来？
预期: 百分比制对低分选手更残酷
原因: 15/30分和25/30分在百分比上差距很大(50% vs 83%)，但在排名上可能只差1名
```

### 4.3 偏向性量化

**必须量化"偏向性"**:
```python
# 定义偏向性指标
judge_correlation = corr(final_rank, judge_rank)
fan_correlation = corr(final_rank, fan_rank)

if judge_correlation > fan_correlation:
    bias = "偏向评委"
else:
    bias = "偏向粉丝"

# 偏向度
bias_degree = abs(judge_correlation - fan_correlation)
```

---

## 五、问题3建模注意点

### 5.1 关键变量

| 变量 | 说明 | 处理方式 |
|------|------|----------|
| `ballroom_partner` | 职业舞者 | One-Hot编码或随机效应 |
| `celebrity_industry` | 明星职业 | 分类编码 |
| `age` | 年龄 | 可能存在非线性关系 |

**职业舞者影响**:
```
关键: 有些职业舞者(如Derek Hough)粉丝极多
影响: 能通过"带飞"队友影响投票
处理: 作为分类变量或随机效应
```

**职业分类建议**:
```
- NFL球员
- 真人秀明星
- 老牌演员
- 乡村音乐歌手（投票极其活跃）
- 其他
```

### 5.2 非线性关系

**年龄的非线性效应**:
```
假设: 
- 年轻人跳得好 → 评委分高
- 老人有情怀分 → 粉丝票高

建模:
- 使用多项式特征: age, age^2
- 或使用分段线性
- 或使用GAM (广义加性模型)
```

### 5.3 ⚠️ 容易忽略的点

**题目明确要求**:
> "Do they impact judges scores and fan votes in the same way?"

**必须分别分析**:
```python
# 模型1: 对评委分的影响
judge_model: JudgeScore ~ Age + Industry + Partner + ...

# 模型2: 对粉丝投票的影响
fan_model: FanVotes ~ Age + Industry + Partner + ...

# 比较两个模型的系数
compare_coefficients(judge_model, fan_model)
```

---

## 六、代码实现检查清单

### 6.1 数据处理检查

- [ ] 是否正确处理了0分（已淘汰选手）？
- [ ] 是否根据赛季自动切换计算逻辑？
- [ ] 是否处理了评委人数变化（3人 vs 4人）？
- [ ] 是否处理了N/A值？
- [ ] 是否处理了多人淘汰/无人淘汰的情况？

### 6.2 规则实现检查

- [ ] S1-S2: 是否使用排名制？排名数值最大者淘汰？
- [ ] S3-S27: 是否使用百分比制？百分比最小者淘汰？
- [ ] S28-S34: 是否实现了Bottom Two + 评委拯救？
- [ ] 是否处理了平局情况？

### 6.3 约束条件检查

- [ ] 粉丝投票份额是否在[0,1]范围内？
- [ ] 粉丝投票份额之和是否等于1（或100%）？
- [ ] 淘汰约束是否正确（被淘汰者 vs 幸存者）？
- [ ] S28+的约束是否只要求被淘汰者在Bottom Two中？

### 6.4 分析完整性检查

- [ ] 问题3是否分别分析了对评委分和粉丝投票的影响？
- [ ] 是否量化了偏向性指标？
- [ ] 是否分析了确定性(Certainty)？

---

## 七、常见错误汇总

| 错误类型 | 错误描述 | 正确做法 |
|----------|----------|----------|
| 规则混淆 | 所有赛季使用同一规则 | 根据赛季自动切换 |
| 排名方向 | 排名数值小者淘汰 | S1-S2: 数值大者淘汰 |
| 百分比方向 | 百分比大者淘汰 | S3-S27: 百分比小者淘汰 |
| 0分处理 | 将0分纳入计算 | 排除已淘汰选手 |
| S28+约束 | 要求被淘汰者排名最后 | 只要求在Bottom Two中 |
| 评委人数 | 直接比较总分 | 归一化处理 |
| 问题3分析 | 只分析对结果的影响 | 分别分析评委分和粉丝投票 |

---

## 八、数学公式汇总

### 排名制 (S1-S2)
$$TotalRank_i = Rank_{judge}(i) + Rank_{fan}(i)$$
$$Eliminated = \arg\max_i TotalRank_i$$

### 百分比制 (S3-S27)
$$\%Judge_i = \frac{JudgeScore_i}{\sum_{j \in Active} JudgeScore_j} \times 100$$
$$\%Fan_i = \frac{FanVotes_i}{\sum_{j \in Active} FanVotes_j} \times 100$$
$$TotalScore_i = \%Judge_i + \%Fan_i$$
$$Eliminated = \arg\min_i TotalScore_i$$

### 混合制 (S28-S34)
$$TotalRank_i = Rank_{judge}(i) + Rank_{fan}(i)$$
$$BottomTwo = \{i : TotalRank_i \geq n-1\}$$
$$Eliminated \in BottomTwo \text{ (由评委决定)}$$

---

*文档版本: v1.0*
*最后更新: 2026-01-30*

---

## 九、代码修复记录

### 2026-01-30 修复内容

#### 9.1 问题1修复（三个方案）

| 修复项 | 修复前 | 修复后 |
|--------|--------|--------|
| 评分方法识别 | 使用`method`字段(0/1) | 使用`get_scoring_method(season)`函数 |
| 0分选手处理 | 未排除 | 添加`week_df = week_df[week_df['本周评委总分'] > 0]` |
| 排名计算 | 手动计算 | 使用`scipy.stats.rankdata(-scores, method='min')` |
| S28+支持 | 未实现 | 添加`has_judges_save`标志 |

#### 9.2 问题2修复

| 修复项 | 修复前 | 修复后 |
|--------|--------|--------|
| VotingSimulator | 只支持两种方法 | 支持三种方法(ranking_early, percentage, ranking_with_save) |
| Bottom Two逻辑 | 简单实现 | 完整实现评委拯救机制 |
| 反事实分析 | 未区分S28+ | 添加`force_judges_save`参数 |

#### 9.3 问题3修复

| 修复项 | 修复前 | 修复后 |
|--------|--------|--------|
| 数据加载 | 未排除0分选手 | 添加排除逻辑 |
| 粉丝投票代理 | 简单使用`100-评委百分比` | 添加`estimate_fan_vote_proxy`函数，区分不同评分方法 |

#### 9.4 问题4修复

| 修复项 | 修复前 | 修复后 |
|--------|--------|--------|
| 仿真数据准备 | 未区分评分方法 | 添加`scoring_method`字段 |
| 测试赛季选择 | 只选4个赛季 | 选择7个赛季覆盖三种方法 |

### 9.5 新增文件

- `model_version_1/utils/data_preprocessing.py`: 通用数据预处理模块
- `model_version_1/utils/__init__.py`: 工具包初始化
- `model_version_1/fix_notebooks.py`: 自动修复脚本

### 9.6 验证结果

所有修复已通过验证：
- ✅ `get_scoring_method`: 正确识别三种评分方法
- ✅ `ranking_early`: S1-2排名制实现
- ✅ `ranking_with_save`: S28+混合制实现
- ✅ `has_judges_save`: 评委拯救标志
- ✅ `stats.rankdata`: 正确的排名计算
- ✅ `bottom_two`: Bottom Two逻辑
- ✅ `force_judges_save`: 反事实分析支持
