[{"cell_type": "markdown", "metadata": {}, "source": ["# 方案B: 贝叶斯MCMC模型", "", "## 思路", "不追求单一最优解，而是求粉丝投票的概率分布。", "", "## 数学形式", "- 先验: 粉丝投票服从 Dirichlet 分布", "- 似然: 根据淘汰结果计算", "- 后验: P(F|Result,Judge) ∝ P(Result|Judge,F) · P(F)", "- 采样: Metropolis-Hastings 算法"]}, {"cell_type": "markdown", "metadata": {}, "source": ["## 1. 环境配置"]}, {"cell_type": "code", "metadata": {}, "source": ["import pandas as pd", "import numpy as np", "from scipy import stats", "from scipy.special import softmax", "import matplotlib.pyplot as plt", "import warnings", "warnings.filterwarnings('ignore')", "", "np.random.seed(42)", "plt.rcParams[\"font.sans-serif\"] = [\"SimHei\", \"DejaVu Sans\"]", "plt.rcParams[\"axes.unicode_minus\"] = False", "COLORS = [\"#E64B35\", \"#4DBBD5\", \"#00A087\", \"#3C5488\", \"#F39B7F\"]", "print('环境配置完成')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 2. 加载数据"]}, {"cell_type": "code", "metadata": {}, "source": ["df = pd.read_excel('../../data/processed/粉丝投票分析.xlsx')", "print(f'数据维度: {df.shape}')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 3. 数据预处理"]}, {"cell_type": "code", "metadata": {}, "source": ["def get_scoring_method(season):", "    if season <= 2:", "        return 'ranking_early'", "    elif season <= 27:", "        return 'percentage'", "    else:", "        return 'ranking_with_save'", "", "def prepare_week_data(df, season, week):", "    week_df = df[(df['赛季'] == season) & (df['第几周'] == week)].copy()", "    week_df = week_df[week_df['本周评委总分'] > 0]", "    ", "    if len(week_df) == 0:", "        return None", "    ", "    scoring_method = get_scoring_method(season)", "    method = 1 if scoring_method == 'percentage' else 0", "    ", "    return {", "        'contestants': week_df['选手姓名'].tolist(),", "        'judge_scores': week_df['本周评委总分'].values,", "        'judge_pct': week_df['评委百分比'].values,", "        'eliminated': week_df[week_df['是否被淘汰'] == 1]['选手姓名'].tolist(),", "        'scoring_method': scoring_method,", "        'method': method,", "        'n_contestants': len(week_df)", "    }", "", "print('数据预处理函数定义完成')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 4. 似然函数"]}, {"cell_type": "code", "metadata": {}, "source": ["def log_likelihood(fan_pct, week_data):", "    contestants = week_data['contestants']", "    judge_pct = week_data['judge_pct']", "    eliminated = week_data['eliminated']", "    method = week_data['method']", "    n = len(contestants)", "    ", "    if len(eliminated) == 0:", "        return 0.0", "    ", "    if method == 1:", "        total_scores = judge_pct + fan_pct", "    else:", "        judge_rank = stats.rankdata(-week_data['judge_scores'])", "        fan_rank = stats.rankdata(-fan_pct)", "        total_scores = -(judge_rank + fan_rank)", "    ", "    elim_idx = [contestants.index(e) for e in eliminated if e in contestants]", "    ", "    log_lik = 0.0", "    for e_idx in elim_idx:", "        score_diff = total_scores - total_scores[e_idx]", "        log_lik += np.sum(np.log(1 / (1 + np.exp(-score_diff[score_diff != 0]))))", "    ", "    return log_lik", "", "print('似然函数定义完成')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 5. MCMC采样器"]}, {"cell_type": "code", "metadata": {}, "source": ["def dirichlet_proposal(current, alpha=1.0):", "    concentration = current * alpha + 1", "    proposed = np.random.dirichlet(concentration) * 100", "    return proposed", "", "def mcmc_sample(week_data, n_samples=1000, burn_in=200):", "    n = len(week_data['contestants'])", "    if n == 0:", "        return None, 0", "    ", "    current = np.ones(n) * (100 / n)", "    current_ll = log_likelihood(current, week_data)", "    ", "    samples = []", "    accepted = 0", "    ", "    for i in range(n_samples + burn_in):", "        proposed = dirichlet_proposal(current / 100) * 100", "        proposed_ll = log_likelihood(proposed, week_data)", "        log_alpha = proposed_ll - current_ll", "        ", "        if np.log(np.random.random()) < log_alpha:", "            current = proposed", "            current_ll = proposed_ll", "            accepted += 1", "        ", "        if i >= burn_in:", "            samples.append(current.copy())", "    ", "    acceptance_rate = accepted / (n_samples + burn_in)", "    return np.array(samples), acceptance_rate", "", "print('MCMC采样器定义完成')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 6. 后验统计量"]}, {"cell_type": "code", "metadata": {}, "source": ["def compute_posterior_stats(samples, contestants):", "    mean = np.mean(samples, axis=0)", "    std = np.std(samples, axis=0)", "    ci_lower = np.percentile(samples, 2.5, axis=0)", "    ci_upper = np.percentile(samples, 97.5, axis=0)", "    ", "    results = {}", "    for i, name in enumerate(contestants):", "        results[name] = {'mean': mean[i], 'std': std[i], 'ci_lower': ci_lower[i], 'ci_upper': ci_upper[i]}", "    return results", "", "def compute_certainty(posterior_stats):", "    ci_widths = [s['ci_upper'] - s['ci_lower'] for s in posterior_stats.values()]", "    avg_width = np.mean(ci_widths)", "    certainty = max(0, 1 - avg_width / 100)", "    return certainty, avg_width", "", "print('后验统计量函数定义完成')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 7. 单元测试"]}, {"cell_type": "code", "metadata": {}, "source": ["print('=' * 60)", "print('单元测试: 第5季第3周')", "print('=' * 60)", "", "week_data = prepare_week_data(df, 5, 3)", "print(f'选手: {week_data[\"contestants\"]}')", "print(f'被淘汰: {week_data[\"eliminated\"]}')", "", "samples, acc_rate = mcmc_sample(week_data, n_samples=500, burn_in=100)", "print(f'采样完成: {len(samples)} 个样本, 接受率: {acc_rate:.2%}')", "", "posterior = compute_posterior_stats(samples, week_data['contestants'])", "certainty, avg_width = compute_certainty(posterior)", "print(f'平均95%CI宽度: {avg_width:.2f}%')", "print(f'确定性度量: {certainty:.2%}')"], "outputs": [], "execution_count": null}, {"cell_type": "markdown", "metadata": {}, "source": ["## 8. 多赛季估算"]}, {"cell_type": "code", "metadata": {}, "source": ["test_seasons = [1, 2, 5, 10, 27, 28, 34]", "all_results = {}", "all_certainties = []", "", "print('开始多赛季估算...')", "for season in test_seasons:", "    season_df = df[df['赛季'] == season]", "    season_results = {}", "    for week in sorted(season_df['第几周'].unique()):", "        week_data = prepare_week_data(df, season, week)", "        if week_data is None or len(week_data['eliminated']) == 0:", "            continue", "        samples, acc_rate = mcmc_sample(week_data, n_samples=200, burn_in=50)", "        if samples is not None:", "            posterior = compute_posterior_stats(samples, week_data['contestants'])", "            cert, width = compute_certainty(posterior)", "            season_results[week] = {'posterior': posterior, 'certainty': cert, 'acceptance_rate': acc_rate}", "            all_certainties.append(cert)", "    all_results[season] = season_results", "    avg_cert = np.mean([r['certainty'] for r in season_results.values()]) if season_results else 0", "    print(f'  第{season:2d}季: {len(season_results)}周, 平均确定性={avg_cert:.2%}')", "", "print(f'\\n总体平均确定性: {np.mean(all_certainties):.2%}')"], "outputs": [], "execution_count": null}]